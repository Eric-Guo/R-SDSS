library(ROracle)
intd_con <- dbConnect(dbDriver("Oracle"),
                      username="insitetapintd",
                      password="insitetapintd",
                      dbname="MESWIP45.SDCORP.GLOBAL.SANDISK.COM")

fetchMESData <- function(con) {
  sql_text = "
SELECT hml.containername, hml.callbycdoname, hml.fromspecname, hml.txndate, hml.qty, pc.packagecategoryname, ptb.productname
FROM historymainline hml
INNER JOIN container co ON co.containerid=hml.containerid
INNER JOIN product pt ON pt.productid=co.productid
INNER JOIN productbase ptb ON ptb.productbaseid=pt.productbaseid
INNER JOIN a_packagecategory pc ON pc.packagecategoryid=pt.packagecategoryid
WHERE hml.fromspecname IN ('3055','3020','3013','3010')
  AND hml.callbycdoname='LotMoveOut' AND hml.cdoname='MoveLot'
  AND hml.containername IN ('M1405M374A.02','M1405M3748.01','E1404M3479.01','M1405M3742.01','M1405M372E.01','M1404M347E.01','M1404M3013.01','E1404M2B8A.01','E1404M2B8B.02','M1404M248D.13','M1405M3742.02','M1404M1F92.06','M1404M34E3.01','M1405M3708.02','M1404M2497.01','M1404M239A.01','M1404M3001.03','M1403M0F69.03','M1405M36F2.02','M1404M2497.05','F1403MFCD6.06','F1403MFCD5.01','Q1404M1929.01','F1403MFCD6.03','M1405M3700.01','M1404M3438.02','M1404M3439.01','M1404M2D45.02','M1404M2CFB.02','Q1404M157F.01','M1404M2FD4.04','E1404M2B8B.01','M1404M2CCD.01','M1404M3236.06','M1404M34E1.01','M1404M3236.03','M1404M2365.02','M1404M2FC5.02','M1404M3236.02','M1404M31C2.03','M1404M299A.02','M1404M34E0.01','M1404M21E7.01','M1405M36EC.01','M1404M30D6.02','M1404M34D8.02','M1404M2CF1.10','M1404M2D41.01','M1404M2CCD.03','M1404M30D6.01','M1404M2D47.03','M1405M36F2.01','M1404M3438.01','M1404M2CCF.02','M1404M34E4.02','M1404M2D47.02','M1404M30D5.02','M1405M36F3.03','M1404M34DD.02','M1404M31E1.02','M1404M299A.01','M1404M348F.03','M1404M30D5.03','M1404M2CF2.09','M1404M2954.01','M1404M31C9.01','M1404M348C.02','M1404M2FC5.03','M1404M31E6.02','M1404M31C4.03','M1405M36F3.04','M1404M2FCA.01','M1404M31C9.02','M1404M342E.01','M1404M2D41.02','M1404M2955.02','M1404M344A.06','M1405M36F2.03','M1404M2D41.03','M1404M3236.01','M1404M34EF.02','M1404M2693.04','M1404M30D5.01','M1404M34CB.02','M1404M29CC.02','M1404M344A.03','M1404M343D.01','M1404M3233.02','M1404M2CCF.01','M1404M3446.01','M1404M2A6B.02','M1404M3233.01','M1404M334F.01','M1404M334F.03','M1404M2A6B.01','M1404M34AD.04','M1404M34A6.04','M1404M3233.05','M1404M2CCD.05','M1404M2CCE.03','M1404M2CCE.01','M1404M34EF.01','M1404M2FBE.01','M1404M31E5.02','M1404M31E4.01','M1404M26A1.01','M1404M2CCE.02','M1404M25C0.02','M1404M2398.03','M1404M2692.03','M1403M11AD.02','M1404M31DC.01','M1404M2FC2.01','M1404M2CEE.03','M1404M2399.04','M1404M31D9.02','M1404M2399.02','M1404M27CE.02','M1404M2FB5.02','M1404M342E.02','M1404M31DD.02','M1404M2A69.02','M1404M31DE.02','M1404M25C1.01','M1404M2CF9.02')
ORDER BY hml.txndate DESC
  "
  
  tb <- fetch(dbSendQuery(con,sql_text), n= -1)
  transform(tb, QTY=as.integer(as.character(QTY)), TXNDATE=as.POSIXct(TXNDATE))
}

pd <- fetchMESData(intd_con)
tm <- melt(pd, id=c("CONTAINERNAME","CALLBYCDONAME","QTY","PACKAGECATEGORYNAME","PRODUCTNAME","FROMSPECNAME"))
dc <- dcast(CONTAINERNAME + CALLBYCDONAME + QTY + PACKAGECATEGORYNAME + PRODUCTNAME ~ FROMSPECNAME, data = tm, value.var = "value", fun.aggregate=max)
